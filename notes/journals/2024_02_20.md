- Yesterday I determined that L1tf cannot be done speculatively. It relies on the page fault to be delivered architecturally. Previously, I used a segfault handler in the userspace program but this was just too slow (around 1.65 ms per check, would take almost 8 hours to verify the first byte of 64GiB of physical memory)
- An idea to speed it up is to do it in kernel space, because that saves the costly context switch and the page fault handler. Hopefully that is much faster.
	- Rough idea could be to add a check like
	  ```c
	  if (reg1 == MAGIC_NUM1 && reg2 == MAGIC_NUM2 && reg3 == MAGIC_NUM3) {
	    special_fault_handling()
	  } else {
	    normal_fault_handling()
	  }
	  ```
	  This allows injection without interfering with the normal linux behavior
- How does the kernel handle a page fault generated by P=0 or a reserved bit = 1?
	- Lazy TLB refresh (from arch/x86/mm/fault.c)
	  > Spurious faults may only occur if the TLB contains an entry with fewer permission than the page table entry.  Non-present (P = 0) and reserved bit (R = 1) faults are never spurious.
	- `exc_page_fault` in `arch/x86/mm/fault.c` is called whenever a page fault is raised
	- which in turn calls `handle_page_fault` in `arch/x86/mm/fault.c`
	- which will call either `do_kern_addr_fault` or `do_user_addr_fault`, depending on the type of address the pagefault happens on
	- either one is likely to eventually call `fixup_exception` which will modify the registers in some way
- Adding an unlikely if to `handle_page_fault` that modifies the instruction pointer to a value of choice IF some registers have a certain value seems like a good option
	- It would be quite fast, because it skips all the checking that we don't really need
- Let's attempt to add this change
	- Use the `linux-rolling-stable` branch from gregkh as a base
	- `make olddefconfig`
	- Use the `boot/config-$(uname -r)` file from the Debian VM that I have been using
		- `uname -a` gives `Linux attacker 6.1.0-18-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.76-1 (2024-02-01) x86_64 GNU/Linux` at the time of writing
		- Disable module signing (see https://itsfoss.com/compile-linux-kernel/)
			- `./scripts/config --file .config --disable MODULE_SIG`
		- `./scripts/config --file .config --set-str LOCALVERSION "-fast-segfaults"`
		- `make`
			- Takes a long time so far...
		- Finally done
		- `sudo make modules_install -j$(nproc)` to install the modules
		- `sudo make install` and restart
		- Works! `uname -a` gives `Linux attacker 6.7.4-fast-segfaults+ #1 SMP PREEMPT_DYNAMIC Tue Feb 20 15:37:07 CET 2024 x86_64 GNU/Linux`
- I tried to apply the patch but compiling is quite slow, again :(
	- Better luck tomorrow I guess